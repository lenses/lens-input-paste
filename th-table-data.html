<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../th-animated/th-animated.html">
<link rel="import" href="../core-collapse/core-collapse.html">
<link rel="import" href="../aha-table/src/aha-table.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">


<!--
Copy any html table or list and paste it inside the text box. It returns
JSON for table/list data.

##### Example

    <th-table-data></th-table-data>

@element th-table-data
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://sepans.github.io/th-table-data
-->
<polymer-element name="th-table-data" extends="th-animated" attributes="output">


  <template>

    <style>
      .disabled {
        color: #EEE;
      }

      core-icon-button {
        vertical-align: top;
      }

      #paste_here {
        height: 35px;
        width: 95px;
      }
      .table-container {
        width: 500px;
        height: 400px;
        overflow: scroll;
        resize: both;
      }
      .label {
        font-family: arial;
        font-size: 12px;
        display: inline-block;
      }


    </style>



    <textarea id="paste_here" placeHolder="paste table here"></textarea>
    <br>

    <label class="label">Concatinate to previous data:</label>
    <input type="checkbox" value="{{concat}}">

    <core-icon-button icon="view-list" on-click="{{showResults}}" class="{{ {disabled: !hasData} | tokenList}}"></core-icon-button>

    <core-collapse id="results_collapse">

      <div class="table-container">
        <!-- aha-table doesn't update the columns -->
        <aha-table id="table" pagesize="10" editable="false"  class="bootstrap" showFooter="true"></aha-table>

      </div>
    </core-collapse>

  </template>

  <script>

    Polymer('th-table-data', {
      tableData: null,
      hasData: false,
      concat: false,

      ready: function() {
        var self = this;


        //self.hasData = false;
        self.$.paste_here.addEventListener('paste', self.processInput.bind(self));
      },

      processInput: function(e) {

          var self = this;
          self.$.paste_here.value="Processing data...";

          var tableData = e.clipboardData.getData('text/html');
          var tableEl = document.createElement('div');
          tableEl.innerHTML = tableData;
          var rows = tableEl.querySelectorAll('tr');

          var dataLabels = [];
          var data = [];

          self.$.table.data = [];

          //if concat is checked and there is output from previous round of pasting
          if(self.concat && self.output) {

              //use the keys from the first current output element.
              dataLabels.push(Object.keys(self.output[0])[j]);
              console.log(dataLabels);
          }


          if(rows.length>0)
          {
            [].forEach.call(rows, function(row, i) {
              //console.log('row', row);
              var extractedRow = {};
              var cells = row.querySelectorAll('td');
              if(i==0 && cells.length==0) {
                cells = row.querySelectorAll('th');
              }
              [].forEach.call(cells, function(cell, j) {
              
                //header
                if(i===0) {
                  if(!self.concat)
                  {


                    var title = cell.innerText || 'no label';
                    //line breaks break the table.
                    title = title.replace(/\n/g, '');
                    //replace space with _
                    title = title.replace(/\s/g, '_');

                    title = title.replace(/^([\d]+)/g, 'x$1');
                    dataLabels.push(title);
                  }

                }
                else {

                  var content = cell.innerText;

                  // try image
                  if(!content) {
                    var img =  cell.querySelector('img');
                    if(img) {
                      content = img.getAttribute('src');
                    }
                  }
                  console.log(dataLabels[j]);

                  if(content) {
                    extractedRow[dataLabels[j]] = content;
                  }


                }
              });
              if(i!==0) {
                data.push(extractedRow);
              }

            });
          
          }
          else {

            var listItems = tableEl.querySelectorAll('li');
            
            [].forEach.call(listItems, function(item) {

              var content = item.innerText;
              if(!content) {
                var img =  cell.querySelector('img');
                if(img) {
                  content = img.getAttribute('src');
                }
              }else {                
                var spaceChar = new RegExp(String.fromCharCode(160), "g"); // catches &nbsp symbol and replaces with a normal space;
                content = content.replace(spaceChar,' ');
                data.push({row: content});
              }
            });



          }

          if(data && data.length>0) {

            setTimeout(function() {

              self.$.paste_here.value="Data processed";

              console.log(data);
              //self.tableData = data;
              self.$.table.data = data;
              self.hasData = true;
              if(self.concat) {
                console.log('concating', data, self.output);
                self.output = self.output.concat(data);
              }
              else {
                self.output = data;
              }
            },100);

          }
          else {
            self.$.paste_here.value="No Table or list found";
            self.hasData = false;
          }


          e.preventDefault();
      },

      showResults: function(e) {
          if(this.hasData) {
            // if(this.$.ctrl_collapse.opened && !this.$.results_collapse.opened) {
            //   this.$.ctrl_collapse.toggle();
            // }
            this.$.results_collapse.toggle();
          }
      }, 
      outputChanged: function(){
        console.log("th-table-data output changed");
        this.fire('th-output-changed', this);
      }


    });

  </script>

</polymer-element>
