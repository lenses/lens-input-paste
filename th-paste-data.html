<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../core-collapse/core-collapse.html">
<link rel="import" href="../aha-table/src/aha-table.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">


<!--
Element providing solution to no problem in particular.

##### Example

    <th-paste-data></th-paste-data>

@element th-paste-data
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://sepans.github.io/th-paste-data
-->
<polymer-element name="th-paste-data" attributes="output">


  <template>

    <style>
      .disabled {
        color: #EEE;
      }

      core-icon-button {
        vertical-align: top;
      }

      #paste_here {
        height: 35px;
      }

    </style>
    <link rel="stylesheet" href="../sortable-table/css/bootstrap.css" shim-shadowdom>



    <textarea id="paste_here" placeHolder="paste table here"></textarea>

    <core-icon-button icon="view-list" on-click="{{showResults}}" class="{{ {disabled: !hasData} | tokenList}}"></core-icon-button>

    <core-collapse id="results_collapse">


      <aha-table id="table" pagesize="10"  class="bootstrap" showFooter="true">

      </aha-table>
    </core-collapse>

  </template>

  <script>

    Polymer('th-paste-data', {
      tableData: null,
      hasData: false,

      ready: function() {
        var self = this;


        //self.hasData = false;
        self.$.paste_here.addEventListener('paste', function(e) {

          self.$.paste_here.value="Processing data";

          var tableData = e.clipboardData.getData('text/html');
          var tableEl = document.createElement('div');
          tableEl.innerHTML = tableData;
          var rows = tableEl.querySelectorAll('tr');

          var dataLabels = [];
          var data = [];

          [].forEach.call(rows, function(row, i) {
            //console.log('row', row);
            var extractedRow = {};
            var cells = row.querySelectorAll('td');
            if(i==0 && cells.length==0) {
              cells = row.querySelectorAll('th');
            }
            [].forEach.call(cells, function(cell, j) {
            
              //header
              if(i===0) {

                var title = cell.innerText || 'no label';
                title = title.replace(/\n/g, '');
                dataLabels.push(title);
                

              }
              else {

                var content = cell.innerText || 'no data';

                if(content==='no data') {

                  // try image
                  var img =  cell.querySelector('img');
                  if(img) {
                    content = img.getAttribute('src');
                  }
                }

                extractedRow[dataLabels[j]] = content;


              }
            });
            if(i!==0) {
              data.push(extractedRow);
            }

          });
          //console.log(rows);

          self.$.paste_here.value="Data processed";

          console.log(data);
          //self.tableData = data;
          self.$.table.data = data;
          self.hasData = true;

          e.preventDefault();

        });
      },

      showResults: function(e) {
          if(this.hasData) {
            // if(this.$.ctrl_collapse.opened && !this.$.results_collapse.opened) {
            //   this.$.ctrl_collapse.toggle();
            // }
            this.$.results_collapse.toggle();
          }
      }, 



    });

  </script>

</polymer-element>
